<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
 <mapper namespace="com.fortrip.com.domain.board.review.model.mapper.BoardReviewMapper">
	<!-- 게시글 총 개수 -->
    <select id="getTotalCount" resultType="_int">
        SELECT COUNT(*)
        FROM REVIEW
        WHERE DELETE_YN = 'N'
    </select>

    <!-- 리뷰 목록 조회 (썸네일 포함) -->
    <select id="selectReviewList" resultType="com.fortrip.com.domain.board.review.model.vo.BoardReview">
        SELECT *
        FROM (
            SELECT
                ROWNUM AS RNUM,
                R_SUB.*
            FROM (
                SELECT
                    R.REVIEW_NO,
                    R.MEMBER_NO,
                    R.ROAD_NO,
                    R.REVIEWER_TYPE,
                    R.REVIEW_TITLE,
                    R.REVIEW_SUBTITLE,
                    R.REVIEW_RATING,
                    M.NICKNAME AS REVIEWWRITER,
                    R.VIEW_COUNT,
                    R.WRITE_DATE,
                    R.THUMBNAIL_PATH, 

                    (SELECT COUNT(*) FROM BOARD_LIKE L
                     WHERE L.BOARD_TYPE = 'REVIEW' AND L.BOARD_NO = R.REVIEW_NO) AS LIKE_COUNT,

                    (SELECT COUNT(*) FROM BOOKMARK B
                     WHERE B.TARGET_TYPE = 'REVIEW' AND B.TARGET_NO = R.REVIEW_NO) AS BOOKMARK_COUNT,

                    (SELECT COUNT(*) FROM BOARD_COMMENT C
                     WHERE C.BOARD_TYPE = 'REVIEW' AND C.BOARD_NO = R.REVIEW_NO AND C.DELETE_YN = 'N') AS COMMENT_COUNT

                FROM REVIEW R
                JOIN MEMBER M ON R.MEMBER_NO = M.MEMBER_NO
                WHERE R.DELETE_YN = 'N'
                ORDER BY R.REVIEW_NO DESC
            ) R_SUB
        )
        WHERE RNUM BETWEEN #{offset} + 1 AND #{offset} + #{reviewCountPerPage}
    </select>

    <!-- 조회수 증가 -->
    <update id="increaseViewCount">
        UPDATE REVIEW
        SET VIEW_COUNT = VIEW_COUNT + 1
        WHERE REVIEW_NO = #{reviewNo}
    </update>

    <!-- 상세 조회 -->
    <select id="selectOneByNo" resultType="com.fortrip.com.domain.board.review.model.vo.BoardReview">
        SELECT
            R.REVIEW_NO,
            R.MEMBER_NO,
            R.ROAD_NO,
            R.REVIEWER_TYPE,
            R.REVIEW_TITLE,
            R.REVIEW_SUBTITLE,
            R.REVIEW_CONTENT,
            R.REVIEW_RATING,
            R.VIEW_COUNT,
            R.WRITE_DATE,
            R.UPDATE_DATE,
            R.DELETE_YN,
            R.THUMBNAIL_PATH,  
            M.NICKNAME AS REVIEWWRITER
        FROM REVIEW R
        JOIN MEMBER M ON R.MEMBER_NO = M.MEMBER_NO
        WHERE R.REVIEW_NO = #{reviewNo}
          AND R.DELETE_YN = 'N'
    </select>

    <!-- 리뷰 등록 -->
    <insert id="insertReview" parameterType="com.fortrip.com.app.board.review.dto.BoardReviewAddRequest">
        <selectKey keyProperty="reviewNo" resultType="_int" order="BEFORE">
            SELECT SEQ_REVIEW_NO.NEXTVAL FROM DUAL
        </selectKey>

        INSERT INTO REVIEW (
            REVIEW_NO,
            MEMBER_NO,
            ROAD_NO,
            REVIEWER_TYPE,
            REVIEW_TITLE,
            REVIEW_SUBTITLE,
            REVIEW_CONTENT,
            REVIEW_RATING,
            THUMBNAIL_PATH
        ) VALUES (
            #{reviewNo},
            #{memberNo},
            #{roadNo, jdbcType=INTEGER},
            #{reviewerType},
            #{reviewTitle},
            #{reviewSubtitle},
            #{reviewContent},
            #{reviewRating},
            #{thumbnailPath, jdbcType=VARCHAR}
        )
    </insert>

    <!-- 리뷰 수정 -->
    <update id="updateReview" parameterType="com.fortrip.com.app.board.review.dto.BoardReviewUpdateRequest">
        UPDATE REVIEW
        SET
            REVIEW_TITLE = #{reviewTitle},
            REVIEW_SUBTITLE = #{reviewSubtitle},
            REVIEW_CONTENT = #{reviewContent},
            REVIEW_RATING = #{reviewRating},
            UPDATE_DATE = SYSDATE
        WHERE REVIEW_NO = #{reviewNo}
          AND DELETE_YN = 'N'
    </update>

    <!-- 리뷰 삭제 -->
    <update id="deleteReview" parameterType="int">
        UPDATE REVIEW
        SET DELETE_YN = 'Y'
        WHERE REVIEW_NO = #{reviewNo}
    </update>

    <!-- 썸네일 경로 업데이트 -->
    <update id="updateThumbnailPath">
        UPDATE REVIEW
        SET THUMBNAIL_PATH = #{thumbnailPath}
        WHERE REVIEW_NO = #{reviewNo}
    </update>
 </mapper>