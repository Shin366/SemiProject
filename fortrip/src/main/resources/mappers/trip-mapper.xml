<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fortrip.com.domain.journey.trip.model.mapper.TripMapper">

  <!-- 공통 WHERE -->
  <sql id="baseWhere">
    WHERE NVL(DELETE_YN,'N') = 'N'
    <if test="destination != null and destination != ''">
      AND (
           LOWER(ROAD_NAME)     LIKE '%' || LOWER(#{destination}) || '%'
        OR LOWER(ROAD_LOCATION) LIKE '%' || LOWER(#{destination}) || '%'
      )
    </if>
  </sql>

  <!-- 목록 -->
  <select id="selectTrips" resultType="com.fortrip.com.domain.journey.trip.model.vo.Trip">
    SELECT
      ROAD_NO        AS roadNo,
      ROAD_NAME      AS roadName,
      ROAD_START     AS roadStart,
      ROAD_END       AS roadEnd,
      ROAD_LOCATION  AS roadLocation,
      ROAD_YN        AS roadYn,
      ROAD_COST      AS roadCost,
      ROAD_STYLE     AS roadStyle,
      ROAD_INTRO     AS roadIntro,
      DELETE_YN      AS deleteYn,
      WRITE_DATE     AS writeDate,
      MEMBER_NO      AS memberNo
    FROM ROAD
    <include refid="baseWhere"/>
    ORDER BY WRITE_DATE DESC NULLS LAST, ROAD_NO DESC
    OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY
  </select>

  <!-- 총 건수 -->
  <select id="countTrips" resultType="int">
    SELECT COUNT(*)
    FROM ROAD
    <include refid="baseWhere"/>
  </select>

  <!-- 상세 -->
  <select id="selectTripById" parameterType="int"
          resultType="com.fortrip.com.domain.journey.trip.model.vo.Trip">
    SELECT
      ROAD_NO        AS roadNo,
      ROAD_NAME      AS roadName,
      ROAD_START     AS roadStart,
      ROAD_END       AS roadEnd,
      ROAD_LOCATION  AS roadLocation,
      ROAD_YN        AS roadYn,
      ROAD_COST      AS roadCost,
      ROAD_STYLE     AS roadStyle,
      ROAD_INTRO     AS roadIntro,
      DELETE_YN      AS deleteYn,
      WRITE_DATE     AS writeDate,
      MEMBER_NO      AS memberNo
    FROM ROAD
    WHERE ROAD_NO = #{id}
      AND NVL(DELETE_YN,'N') = 'N'
  </select>

  <!-- 등록 -->
  <!-- TripMapper.xml (insert) -->
<insert id="insertRoad" parameterType="com.fortrip.com.domain.journey.trip.model.vo.Trip">
  INSERT INTO ROAD (
    ROAD_NO, ROAD_NAME, ROAD_START, ROAD_END,
    ROAD_LOCATION, ROAD_YN, ROAD_COST, ROAD_STYLE,
    ROAD_INTRO, MEMBER_NO, DELETE_YN, WRITE_DATE
  ) VALUES (
    SEQ_ROAD_NO.NEXTVAL,
    #{roadName},
    #{roadStart},
    #{roadEnd},
    #{roadLocation},
    #{roadYn},
    #{roadCost},
    #{roadStyle},
    #{roadIntro},
    #{memberNo, jdbcType=NUMERIC},   <!-- ★ 여기 -->
    'N',
    SYSTIMESTAMP
  )
</insert>

  <!-- 수정 (작성자 또는 관리자만) -->
  <update id="updateTrip" parameterType="com.fortrip.com.domain.journey.trip.model.vo.Trip">
    UPDATE ROAD
       SET ROAD_NAME     = #{roadName},
           ROAD_START    = #{roadStart},
           ROAD_END      = #{roadEnd},
           ROAD_LOCATION = #{roadLocation},
           ROAD_COST     = #{roadCost},
           ROAD_STYLE    = #{roadStyle},
           ROAD_INTRO    = #{roadIntro}
     WHERE ROAD_NO = #{roadNo}
       AND NVL(DELETE_YN,'N') = 'N'
  </update>

  <!-- 삭제(소프트) : 컨트롤러/서비스에서 권한 체크 후 호출 -->
  <update id="softDelete">
    UPDATE ROAD
       SET DELETE_YN = 'Y'
     WHERE ROAD_NO = #{id}
       AND NVL(DELETE_YN,'N') = 'N'
       <if test="!admin">
         AND MEMBER_NO = #{memberNo}
       </if>
  </update>

  <!-- (옵션) 관리자 글만 -->
  <select id="selectAdminTrips" resultType="com.fortrip.com.domain.journey.trip.model.vo.Trip">
    SELECT
      ROAD_NO AS roadNo,
      ROAD_NAME AS roadName,
      ROAD_START AS roadStart,
      ROAD_END AS roadEnd,
      ROAD_LOCATION AS roadLocation,
      ROAD_YN AS roadYn,
      ROAD_COST AS roadCost,
      ROAD_STYLE AS roadStyle,
      ROAD_INTRO AS roadIntro,
      DELETE_YN AS deleteYn,
      WRITE_DATE AS writeDate,
      MEMBER_NO AS memberNo
    FROM ROAD R
    JOIN MEMBER M ON M.MEMBER_NO = R.MEMBER_NO AND NVL(M.ADMIN_YN,'N')='Y'
    <include refid="baseWhere"/>
    ORDER BY WRITE_DATE DESC NULLS LAST, ROAD_NO DESC
    OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY
  </select>

  <select id="countAdminTrips" resultType="int">
    SELECT COUNT(*)
    FROM ROAD R
    JOIN MEMBER M ON M.MEMBER_NO = R.MEMBER_NO AND NVL(M.ADMIN_YN,'N')='Y'
    <include refid="baseWhere"/>
  </select>

</mapper>
